<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis - Asistente de Ciberseguridad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --text: #1e293b;
            --text-light: #64748b;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(67, 97, 238, 0.15);
        }
        
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .chat-container {
            width: 100%;
            max-width: 1000px;
            height: 90vh;
            background-color: var(--card);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 60px var(--shadow);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chat-header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 24px 32px;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="white" opacity="0.05"/></svg>');
            pointer-events: none;
        }
        
        .bot-icon {
            width: 70px;
            height: 70px;
            margin-right: 20px;
            border-radius: 20px;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 2;
            animation: pulse-glow 2s infinite alternate;
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 8px 20px rgba(67, 97, 238, 0.2); }
            100% { box-shadow: 0 8px 30px rgba(67, 97, 238, 0.4); }
        }
        
        .bot-info {
            flex: 1;
            position: relative;
            z-index: 2;
            min-width: 0;
        }
        
        .bot-info h1 {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .bot-info p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 18px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 2;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success);
            margin-right: 10px;
            position: relative;
        }
        
        .status-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background-color: var(--success);
            opacity: 0.4;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .chat-status span {
            color: white;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .user-type-tag {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            border-radius: 20px;
            font-size: 12px;
            color: white;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .chat-messages {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--bg);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .message {
            max-width: 78%;
            margin-bottom: 24px;
            padding: 18px 22px;
            border-radius: 22px;
            line-height: 1.6;
            animation: fadeInUp 0.4s cubic-bezier(0.21, 0.61, 0.35, 1);
            position: relative;
            word-wrap: break-word;
            hyphens: auto;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-message {
            background-color: white;
            border: 1px solid var(--border);
            border-bottom-left-radius: 8px;
            align-self: flex-start;
            box-shadow: 0 4px 12px var(--shadow);
            border-left: 4px solid var(--primary);
        }
        
        .bot-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -12px;
            width: 0;
            height: 0;
            border-top: 12px solid white;
            border-left: 12px solid transparent;
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-bottom-right-radius: 8px;
            align-self: flex-end;
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.25);
        }
        
        .user-message::after {
            content: '';
            position: absolute;
            top: 0;
            right: -12px;
            width: 0;
            height: 0;
            border-top: 12px solid var(--primary);
            border-right: 12px solid transparent;
        }
        
        .message-content {
            font-size: 15.5px;
            line-height: 1.6;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 10px;
            text-align: right;
            font-weight: 500;
        }
        
        .user-message .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Estilos para secciones de respuesta */
        .explanation-section {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--accent);
        }
        
        .services-section {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--success);
        }
        
        .info-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }
        
        .training-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #a855f7;
        }
        
        .whatsapp-section {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #25D366;
            text-align: center;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .services-list, .info-list, .training-list {
            list-style-type: none;
            padding-left: 0;
        }
        
        .services-list li, .info-list li, .training-list li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .services-list li:last-child, .info-list li:last-child, .training-list li:last-child {
            border-bottom: none;
        }
        
        .services-list li::before {
            content: 'üõ°Ô∏è';
            position: absolute;
            left: 0;
            top: 8px;
        }
        
        .info-list li::before {
            content: 'üìç';
            position: absolute;
            left: 0;
            top: 8px;
        }
        
        .training-list li::before {
            content: 'üéì';
            position: absolute;
            left: 0;
            top: 8px;
        }
        
        .quick-replies {
            padding: 24px 32px;
            background-color: white;
            border-top: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            max-height: 160px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .quick-reply-btn {
            background-color: white;
            border: 1.5px solid var(--primary-light);
            color: var(--primary);
            padding: 12px 22px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14.5px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.1);
        }
        
        .quick-reply-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow-hover);
            border-color: var(--primary);
        }
        
        .chat-input-area {
            display: flex;
            padding: 24px 32px;
            border-top: 1px solid var(--border);
            background-color: white;
            gap: 12px;
            align-items: center;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #user-input {
            width: 100%;
            padding: 18px 24px;
            padding-right: 60px;
            border: 2px solid var(--border);
            border-radius: 50px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        #user-input:focus {
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }
        
        .input-icon {
            position: absolute;
            right: 22px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 20px;
        }
        
        #send-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.25);
            flex-shrink: 0;
        }
        
        #send-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.35);
        }
        
        #send-btn:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Bot√≥n de limpieza en el √°rea de entrada */
        #clear-chat-btn {
            background: rgba(248, 113, 113, 0.1);
            border: 1.5px solid var(--danger);
            color: var(--danger);
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        #clear-chat-btn:hover {
            background-color: var(--danger);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.25);
        }
        
	.welcome-message {
            text-align: center;
            margin-bottom: 32px;
            padding: 28px;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(72, 149, 239, 0.05) 100%);
            border-radius: 22px;
            border: 1px solid rgba(67, 97, 238, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
        }
        
        .welcome-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-message h2 {
            font-size: 24px;
            color: var(--text);
            margin-bottom: 12px;
            font-weight: 700;
            line-height: 1.3;
        }
        
        .welcome-message p {
            font-size: 16px;
            color: var(--text-light);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            align-self: flex-start;
            background-color: white;
            padding: 16px 24px;
            border-radius: 22px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            border-left: 4px solid var(--accent);
        }
        
        .typing-text {
            font-size: 14px;
            color: var(--text-light);
            margin-right: 16px;
            font-weight: 500;
        }
        
        .typing-dots {
            display: flex;
            gap: 6px;
        }
        
        .typing-dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-light);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.1); opacity: 1; }
        }


        /* Estilos para WhatsApp */
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #25D366;
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .whatsapp-link:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }
        
        .whatsapp-info {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 8px;
            font-style: italic;
        }
        
        .contact-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .contact-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }
        
        .context-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--text);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            margin: 5px 0;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .tone-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 15px;
            color: var(--text-light);
            font-size: 12px;
            padding: 6px 12px;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(67, 97, 238, 0.1);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .chat-container {
                height: 95vh;
                border-radius: 20px;
            }
            
            .chat-header {
                padding: 20px 24px;
                flex-wrap: wrap;
            }
            
            .chat-status {
                margin-top: 10px;
                margin-left: 0;
                width: 100%;
                justify-content: center;
            }
            
            .bot-icon {
                width: 60px;
                height: 60px;
                margin-right: 16px;
            }
            
            .bot-info h1 {
                font-size: 24px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-type-tag {
                margin-top: 5px;
            }
            
            .chat-messages {
                padding: 24px;
            }
            
            .message {
                max-width: 90%;
                padding: 16px 20px;
            }
            
            .quick-replies {
                padding: 20px 24px;
                max-height: 140px;
            }
            
            .quick-reply-btn {
                padding: 10px 18px;
                font-size: 14px;
            }
            
            .chat-input-area {
                padding: 20px 24px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            #user-input {
                padding: 16px 20px;
                padding-right: 50px;
                width: 100%;
                order: 1;
            }
            
            #send-btn {
                width: 52px;
                height: 52px;
                order: 2;
            }
            
            #clear-chat-btn {
                order: 3;
                padding: 10px 16px;
                font-size: 13px;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .whatsapp-link {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .chat-container {
                border-radius: 16px;
            }
            
            .quick-replies {
                gap: 10px;
            }
            
            .quick-reply-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .welcome-message {
                padding: 20px;
            }
            
            .welcome-message h2 {
                font-size: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-overlay"></div>
            <div class="bot-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#4361ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <path d="M12 8v4M12 16h.01"/>
                </svg>
            </div>
            <div class="bot-info">
                <h1>Aegis <span class="user-type-tag" id="user-type">üë§ General</span></h1>
                <p>Tu asistente de seguridad inform√°tica</p>
            </div>
            <div class="chat-status">
                <div class="status-indicator"></div>
                <span id="status-text">Listo para ayudarte</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="welcome-message">
                <div class="welcome-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>¬°Hola! Soy Aegis, tu asistente virtual especializado en seguridad inform√°tica.</h2>
                <p>Estoy aqu√≠ para ayudarte a proteger tu informaci√≥n y resolver tus dudas sobre nuestros servicios. ¬øEn qu√© puedo ayudarte hoy?</p>
                <div class="context-badge">
                    <i class="fas fa-info-circle"></i>
                    Mi tono se adapta a tus necesidades: t√©cnico, simple o empresarial
                </div>
            </div>
        </div>
        
        <div class="quick-replies" id="quick-replies">
            <!-- Los botones de quick replies se agregar√°n aqu√≠ din√°micamente -->
        </div>
        
        <div class="chat-input-area">
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Escribe tu pregunta sobre ciberseguridad...">
                <div class="input-icon">
                    <i class="far fa-keyboard"></i>
                </div>
            </div>
            <button id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button id="clear-chat-btn" title="Limpiar chat y comenzar de nuevo">
                <i class="fas fa-trash-alt"></i> Limpiar Chat
            </button>
        </div>
    </div>

    <script>
        // Sistema de Usuario y Contexto Mejorado
        class UserContext {
            constructor() {
                this.userType = 'general';
                this.preferredTone = 'balanced';
                this.interactionCount = 0;
                this.technicalKeywords = [];
                this.businessKeywords = [];
                this.personalKeywords = [];
                this.initializeKeywords();
            }
            
            initializeKeywords() {
                this.technicalKeywords = [
                    'firewall', 'siem', 'edr', 'vpn', 'ssl', 'tls', 'api', 'server', 
                    'protocolo', 'puerto', 'configuraci√≥n', 'infraestructura', 'redes',
                    'cifrado', 'autenticaci√≥n', 'autorizaci√≥n', 'endpoint', 'parche',
                    'vulnerabilidad', 'exploit', 'pentesting', 'hardening', 'backup',
                    'restore', 'disaster recovery', 'ids', 'ips', 'dmz', 'proxy'
                ];
                
                this.businessKeywords = [
                    'empresa', 'negocio', 'corporaci√≥n', 'corporativo', 'pyme',
                    'empleados', 'equipo', 'gerencia', 'director', 'jefe',
                    'presupuesto', 'inversi√≥n', 'roi', 'productividad', 'continuidad',
                    'cumplimiento', 'normativa', 'regulaci√≥n', 'legal', 'contrato',
                    'proveedor', 'cliente', 'auditor√≠a', 'riesgo', 'estrategia',
                    'corporativa', 'organizaci√≥n', 'departamento', 'staff', 'personal'
                ];
                
                this.personalKeywords = [
                    'mi', 'yo', 'personal', 'casa', 'hogar', 'familia', 'amigo',
                    'computadora', 'pc', 'laptop', 'tablet', 'celular', 'tel√©fono',
                    'fotos', 'documentos', 'archivos', 'cuenta', 'contrase√±a',
                    'internet', 'wifi', 'red', 'dom√©stica', 'hogare√±a', 'privado',
                    'individual', 'usuario', 'particular', 'propio', 'm√≠o'
                ];
            }
            
            analyzeQuestion(question) {
                this.interactionCount++;
                const lowerQuestion = question.toLowerCase();
                
                this.detectUserType(lowerQuestion);
                this.detectPreferredTone(lowerQuestion);
                this.updateUI();
                
                return {
                    userType: this.userType,
                    tone: this.preferredTone,
                    isTechnical: this.hasTechnicalTerms(lowerQuestion),
                    isBusiness: this.hasBusinessTerms(lowerQuestion),
                    isPersonal: this.hasPersonalTerms(lowerQuestion)
                };
            }
            
            detectUserType(lowerQuestion) {
                let techScore = 0;
                let businessScore = 0;
                let personalScore = 0;
                
                this.technicalKeywords.forEach(keyword => {
                    if (lowerQuestion.includes(keyword)) techScore++;
                });
                
                this.businessKeywords.forEach(keyword => {
                    if (lowerQuestion.includes(keyword)) businessScore++;
                });
                
                this.personalKeywords.forEach(keyword => {
                    if (lowerQuestion.includes(keyword)) personalScore++;
                });
                
                const scores = { techScore, businessScore, personalScore };
                const maxScore = Math.max(techScore, businessScore, personalScore);
                
                if (maxScore === 0) {
                    this.userType = 'general';
                } else if (maxScore === techScore) {
                    this.userType = 'tecnico';
                } else if (maxScore === businessScore) {
                    this.userType = 'empresa';
                } else {
                    this.userType = 'personal';
                }
            }
            
            detectPreferredTone(lowerQuestion) {
                if (this.userType === 'tecnico') {
                    this.preferredTone = 'technical';
                } else if (this.userType === 'empresa') {
                    this.preferredTone = 'business';
                } else if (this.userType === 'personal') {
                    this.preferredTone = 'simple';
                } else {
                    if (this.hasTechnicalTerms(lowerQuestion)) {
                        this.preferredTone = 'technical';
                    } else if (this.hasBusinessTerms(lowerQuestion)) {
                        this.preferredTone = 'business';
                    } else {
                        this.preferredTone = 'simple';
                    }
                }
            }
            
            hasTechnicalTerms(text) {
                return this.technicalKeywords.some(keyword => text.includes(keyword));
            }
            
            hasBusinessTerms(text) {
                return this.businessKeywords.some(keyword => text.includes(keyword));
            }
            
            hasPersonalTerms(text) {
                return this.personalKeywords.some(keyword => text.includes(keyword));
            }
            
            updateUI() {
                const userTypeElement = document.getElementById('user-type');
                const statusText = document.getElementById('status-text');
                
                const userTypeLabels = {
                    'empresa': 'üè¢ Empresa',
                    'personal': 'üë§ Personal',
                    'tecnico': '‚öôÔ∏è T√©cnico',
                    'general': 'üë§ General'
                };
                
                const toneLabels = {
                    'simple': 'Simple',
                    'technical': 'T√©cnico',
                    'business': 'Empresarial',
                    'balanced': 'Balanceado'
                };
                
                userTypeElement.textContent = userTypeLabels[this.userType] || 'üë§ General';
                
                if (this.interactionCount === 1) {
                    statusText.textContent = "Analizando tu consulta...";
                } else if (this.interactionCount > 3) {
                    statusText.textContent = `Modo: ${toneLabels[this.preferredTone]}`;
                } else {
                    statusText.textContent = "Listo para ayudarte";
                }
            }
            
            reset() {
                this.userType = 'general';
                this.preferredTone = 'balanced';
                this.interactionCount = 0;
                this.updateUI();
            }
        }

        // Base de Conocimientos Completa
        const knowledgeBase = {
            "horario": {
                keywords: ["horario", "horas", "atienden", "abierto", "cerrado", "cu√°ndo", "apertura", "cierre"],
                isInfo: true,
                info: {
                    simple: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-clock"></i> Nuestro Horario de Atenci√≥n:
                            </div>
                            <ul class="info-list">
                                <li><strong>Lunes a Viernes:</strong> 9:00 AM - 6:00 PM</li>
                                <li><strong>S√°bados:</strong> 10:00 AM - 2:00 PM</li>
                                <li><strong>Domingos:</strong> Cerrado</li>
                                <li><strong>Emergencias:</strong> 24/7 v√≠a WhatsApp</li>
                            </ul>
                            <p style="margin-top: 10px; font-style: italic;">
                                <i class="fas fa-info-circle"></i> Para emergencias de seguridad, contamos con soporte prioritario las 24 horas.
                            </p>
                        </div>
                    `,
                    technical: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-clock"></i> Horarios Operativos:
                            </div>
                            <ul class="info-list">
                                <li><strong>Horario Comercial:</strong> Lunes-Viernes 09:00-18:00 (UTC-5)</li>
                                <li><strong>Soporte T√©cnico:</strong> Lunes-S√°bado 08:00-20:00</li>
                                <li><strong>SLA Cr√≠tico:</strong> 24/7 para incidentes de seguridad</li>
                                <li><strong>Monitorizaci√≥n:</strong> 24/7/365 sin interrupciones</li>
                            </ul>
                        </div>
                    `,
                    business: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-clock"></i> Horario Corporativo:
                            </div>
                            <ul class="info-list">
                                <li><strong>Atenci√≥n Ejecutiva:</strong> Lunes-Viernes 8:00-20:00</li>
                                <li><strong>Soporte Empresarial:</strong> 24/7 para clientes premium</li>
                                <li><strong>Respuesta a Incidentes:</strong> M√°ximo 1 hora (SLA Gold)</li>
                                <li><strong>Consultor√≠a Estrat√©gica:</strong> Por cita previa</li>
                            </ul>
                        </div>
                    `
                }
            },
            "ubicacion": {
                keywords: ["ubicaci√≥n", "direcci√≥n", "d√≥nde est√°n", "local", "oficina", "direccion", "sucursal"],
                isInfo: true,
                info: {
                    simple: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-map-marker-alt"></i> Nuestra Ubicaci√≥n:
                            </div>
                            <ul class="info-list">
                                <li><strong>Direcci√≥n:</strong> Av. Tecnolog√≠a #1234, Col. Digital</li>
                                <li><strong>Ciudad:</strong> CyberCity</li>
                                <li><strong>C.P.:</strong> 04510</li>
                                <li><strong>Referencia:</strong> Frente al Parque Tecnol√≥gico</li>
                            </ul>
                            <p style="margin-top: 10px;">
                                <i class="fas fa-car"></i> Estacionamiento gratuito disponible
                            </p>
                            <a href="https://maps.app.goo.gl/QwbsV61pbyfezrMj7" class="contact-link" style="margin-top: 15px;">
                                <i class="fas fa-directions"></i> Ver en Google Maps
                            </a>
                        </div>
                    `,
                    technical: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-map-marker-alt"></i> Centro de Operaciones de Seguridad:
                            </div>
                            <ul class="info-list">
                                <li><strong>Coordenadas:</strong> 19.4326¬∞ N, 99.1332¬∞ W</li>
                                <li><strong>Direcci√≥n T√©cnica:</strong> Data Center #5, Zona Tecnol√≥gica</li>
                                <li><strong>Nivel de Seguridad:</strong> Tier III</li>
                                <li><strong>Acceso:</strong> Control biom√©trico 24/7</li>
                            </ul>
                        </div>
                    `,
                    business: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-map-marker-alt"></i> Oficinas Corporativas:
                            </div>
                            <ul class="info-list">
                                <li><strong>Torre Executiva:</strong> Piso 25, Oficina 2501</li>
                                <li><strong>Direcci√≥n Ejecutiva:</strong> Blvd. Corporativo 1000</li>
                                <li><strong>Centro de Operaciones:</strong> Zona Franca Tecnol√≥gica</li>
                                <li><strong>Reuniones Ejecutivas:</strong> Sala de juntas disponible</li>
                            </ul>
                            <p style="margin-top: 10px;">
                                <i class="fas fa-phone"></i> Para visitas corporativas, agendar cita previa
                            </p>
                        </div>
                    `
                }
            },
            "contacto": {
                keywords: ["tel√©fono", "contacto", "llamar", "correo", "email", "n√∫mero", "celular", "whatsapp"],
                isInfo: true,
                info: {
                    simple: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-address-book"></i> Contacto:
                            </div>
                            <ul class="info-list">
                                <li><strong>Tel√©fono Fijo:</strong> (555) 123-4567</li>
                                <li><strong>WhatsApp:</strong> +1 (555) 987-6543</li>
                                <li><strong>Email:</strong> info@aegisseguridad.com</li>
                                <li><strong>Sitio Web:</strong> www.aegisseguridad.com</li>
                            </ul>
                            <a href="https://wa.me/15559876543" target="_blank" class="whatsapp-link">
                                <i class="fab fa-whatsapp"></i> Contactar por WhatsApp
                            </a>
                        </div>
                    `,
                    technical: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-headset"></i> Soporte T√©cnico:
                            </div>
                            <ul class="info-list">
                                <li><strong>Soporte General:</strong> soporte@aegisseguridad.com</li>
                                <li><strong>Emergencias T√©cnicas:</strong> +1 (555) 911-9111</li>
                                <li><strong>Ticketing:</strong> tickets.aegisseguridad.com</li>
                                <li><strong>Documentaci√≥n:</strong> docs.aegisseguridad.com</li>
                            </ul>
                            <p style="margin-top: 10px; font-style: italic;">
                                <i class="fas fa-exclamation-triangle"></i> Para incidentes cr√≠ticos, use la l√≠nea de emergencia
                            </p>
                        </div>
                    `,
                    business: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-briefcase"></i> Contacto Empresarial:
                            </div>
                            <ul class="info-list">
                                <li><strong>Ventas Corporativas:</strong> ventas@aegisseguridad.com</li>
                                <li><strong>Consultor√≠a Ejecutiva:</strong> ejecutivo@aegisseguridad.com</li>
                                <li><strong>Tel√©fono Corporativo:</strong> +1 (555) 222-3333</li>
                                <li><strong>Sala de Juntas Virtual:</strong> teams.aegisseguridad.com</li>
                            </ul>
                            <a href="#" class="contact-link" style="margin-top: 15px;">
                                <i class="fas fa-calendar-check"></i> Agendar Reuni√≥n Ejecutiva
                            </a>
                        </div>
                    `
                }
            },
            "servicios": {
                keywords: ["servicios", "ofrecen", "productos", "soluciones", "qu√© hacen", "qu√© ofrecen"],
                explanations: {
                    simple: "Ofrecemos una variedad de servicios para proteger tu informaci√≥n digital, desde seguridad b√°sica hasta soluciones avanzadas.",
                    technical: "Nuestro portafolio de servicios t√©cnicos abarca desde implementaci√≥n de controles de seguridad b√°sicos hasta soluciones avanzadas de ciberdefensa, siguiendo metodolog√≠as reconocidas y mejores pr√°cticas del sector.",
                    business: "Proporcionamos un ecosistema completo de servicios de ciberseguridad empresarial dise√±ados para proteger activos cr√≠ticos, garantizar cumplimiento regulatorio y fortalecer la postura de seguridad organizacional."
                },
                services: {
                    simple: [
                        "Protecci√≥n antivirus y anti-malware",
                        "Seguridad de redes Wi-Fi",
                        "Copias de seguridad en la nube",
                        "Asesor√≠a personal b√°sica",
                        "Recuperaci√≥n de datos"
                    ],
                    technical: [
                        "Pentesting y auditor√≠as de seguridad",
                        "Implementaci√≥n de firewalls NGFW",
                        "Sistemas de detecci√≥n de intrusos (IDS/IPS)",
                        "Gesti√≥n de vulnerabilidades",
                        "Monitoreo de seguridad 24/7"
                    ],
                    business: [
                        "Consultor√≠a estrat√©gica en ciberseguridad",
                        "Programas de cumplimiento normativo",
                        "Planes de continuidad de negocio",
                        "Gesti√≥n de incidentes de seguridad",
                        "Capacitaci√≥n corporativa"
                    ]
                },
                isTechnical: true
            },
            "capacitacion": {
                keywords: ["capacitaci√≥n", "cursos", "entrenamiento", "formaci√≥n", "aprender", "educaci√≥n", "capacitacion", "capacitaciones"],
                explanations: {
                    simple: "Ofrecemos capacitaciones pr√°cticas para que aprendas a proteger tu informaci√≥n digital y navegar seguro en internet.",
                    technical: "Nuestros programas de capacitaci√≥n t√©cnica est√°n dise√±ados para desarrollar habilidades especializadas en ciberseguridad, utilizando metodolog√≠as hands-on y laboratorios pr√°cticos.",
                    business: "Implementamos programas de capacitaci√≥n empresarial que transforman la cultura de seguridad organizacional, reduciendo riesgos humanos y fortaleciendo la postura de seguridad corporativa."
                },
                services: {
                    simple: [
                        "Curso b√°sico de seguridad digital",
                        "Taller de protecci√≥n contra phishing",
                        "Seminario de seguridad en redes sociales",
                        "Entrenamiento en contrase√±as seguras",
                        "Workshop de backup y recuperaci√≥n"
                    ],
                    technical: [
                        "Certificaci√≥n en Ethical Hacking",
                        "Curso avanzado de an√°lisis de malware",
                        "Entrenamiento en respuesta a incidentes",
                        "Capacitaci√≥n en firewalls y redes",
                        "Workshop de forensia digital"
                    ],
                    business: [
                        "Programa de concienciaci√≥n corporativa",
                        "Capacitaci√≥n para equipos de TI",
                        "Entrenamiento ejecutivo en ciberseguridad",
                        "Workshop de cumplimiento normativo",
                        "Simulaciones de ataques phishing empresarial"
                    ]
                },
                isTechnical: true
            },
            "firewall": {
                keywords: ["firewall", "cortafuegos", "filtro", "bloqueo", "puerto", "seguridad perimetral"],
                explanations: {
                    simple: "Un firewall es como un guardia de seguridad digital que controla qu√© informaci√≥n puede entrar y salir de tu red. Revisa todo el tr√°fico de internet y bloquea lo peligroso.",
                    technical: "Un firewall es un sistema de seguridad de red que monitorea y controla el tr√°fico de red entrante y saliente basado en reglas de seguridad predeterminadas. Funciona a nivel de red (paquetes) y aplicaci√≥n, implementando pol√≠ticas de control de acceso mediante listas ACL (Access Control Lists).",
                    business: "El firewall es un componente cr√≠tico de la seguridad perimetral empresarial que act√∫a como barrera entre la red interna confiable y redes externas no confiables, implementando pol√≠ticas de seguridad corporativas y cumpliendo con regulaciones de protecci√≥n de datos."
                },
                services: {
                    simple: [
                        "Instalaci√≥n de firewall b√°sico para tu hogar",
                        "Configuraci√≥n de seguridad Wi-Fi",
                        "Protecci√≥n contra intrusiones",
                        "Monitoreo b√°sico de red"
                    ],
                    technical: [
                        "Implementaci√≥n de firewalls de pr√≥xima generaci√≥n (NGFW)",
                        "Configuraci√≥n de pol√≠ticas granulares por aplicaci√≥n/usuario",
                        "Integraci√≥n con sistemas SIEM para correlaci√≥n de eventos",
                        "Segmentaci√≥n de red y microsegmentaci√≥n",
                        "VPN Site-to-Site y SSL VPN"
                    ],
                    business: [
                        "Arquitectura de seguridad perimetral corporativa",
                        "Firewalls de alta disponibilidad para continuidad de negocio",
                        "Cumplimiento de regulaciones (GDPR, PCI-DSS, ISO 27001)",
                        "Gesti√≥n centralizada de m√∫ltiples dispositivos",
                        "Reporting ejecutivo y dashboards de seguridad"
                    ]
                },
                isTechnical: true
            },
            "malware": {
                keywords: ["virus", "malware", "ransomware", "antivirus", "infectado", "troyano", "spyware"],
                explanations: {
                    simple: "El malware es software malicioso dise√±ado para da√±ar tu computadora. Puede robar informaci√≥n, da√±ar archivos o tomar control de tu dispositivo.",
                    technical: "Malware (Malicious Software) incluye diversas amenazas como virus, troyanos, ransomware, spyware y adware. Estos programas ejecutan acciones no autorizadas comprometiendo la confidencialidad, integridad y disponibilidad de los sistemas mediante t√©cnicas de infecci√≥n, persistencia y evasi√≥n.",
                    business: "El malware representa una amenaza cr√≠tica para las operaciones empresariales, pudiendo causar interrupciones operacionales, robo de propiedad intelectual, violaciones de datos y da√±o reputacional, afectando directamente la continuidad del negocio y el cumplimiento regulatorio."
                },
                services: {
                    simple: [
                        "Limpieza y eliminaci√≥n de virus",
                        "Instalaci√≥n de antivirus",
                        "Protecci√≥n en tiempo real",
                        "Escaneo completo del sistema"
                    ],
                    technical: [
                        "Endpoint Detection and Response (EDR)",
                        "Sandboxing avanzado para an√°lisis de amenazas",
                        "Protecci√≥n anti-ransomware con rollback autom√°tico",
                        "Machine learning para detecci√≥n de amenazas zero-day",
                        "Gesti√≥n centralizada de endpoints"
                    ],
                    business: [
                        "Soluci√≥n empresarial de protecci√≥n de endpoints",
                        "Plan de respuesta a incidentes de malware",
                        "Backups seguros y planes de recuperaci√≥n",
                        "Capacitaci√≥n en concienciaci√≥n de seguridad",
                        "Seguro cibern√©tico y gesti√≥n de riesgos"
                    ]
                },
                isTechnical: true
            },
            "empresa": {
                keywords: ["empresa", "negocio", "corporaci√≥n", "pyme", "empleados", "corporativo", "organizaci√≥n"],
                explanations: {
                    simple: "La seguridad empresarial protege todos los aspectos digitales de una empresa: computadoras, servidores, datos y la informaci√≥n de los clientes.",
                    technical: "La ciberseguridad empresarial implica la implementaci√≥n de un framework de seguridad integral que abarca people, process y technology, incluyendo controles preventivos, detectivos y correctivos alineados con marcos como NIST, ISO 27001 o CIS Controls.",
                    business: "La seguridad inform√°tica empresarial es una funci√≥n estrat√©gica que protege los activos digitales cr√≠ticos, garantiza la continuidad operacional, cumple con requisitos regulatorios y protege la reputaci√≥n de la organizaci√≥n frente a amenazas cibern√©ticas en constante evoluci√≥n."
                },
                services: {
                    simple: [
                        "Protecci√≥n b√°sica para peque√±as empresas",
                        "Seguridad de redes y Wi-Fi",
                        "Copias de seguridad autom√°ticas",
                        "Asesor√≠a b√°sica de seguridad"
                    ],
                    technical: [
                        "Arquitectura de seguridad zero-trust",
                        "Sistema SIEM para correlaci√≥n de eventos",
                        "Gesti√≥n de vulnerabilidades y parches",
                        "Pruebas de penetraci√≥n y auditor√≠as",
                        "Automatizaci√≥n de respuestas (SOAR)"
                    ],
                    business: [
                        "Programa de gesti√≥n de seguridad de la informaci√≥n",
                        "Cumplimiento normativo y auditor√≠as",
                        "Plan de continuidad de negocio",
                        "Seguro cibern√©tico empresarial",
                        "Concienciaci√≥n y capacitaci√≥n corporativa"
                    ]
                },
                isTechnical: true
            },
            "asesoria": {
                keywords: ["asesor√≠a", "consultor√≠a", "consejo", "recomendaci√≥n", "hablar", "experto", "asesor"],
                explanations: {
                    simple: "La asesor√≠a en ciberseguridad te ayuda a entender qu√© protecci√≥n necesitas y c√≥mo implementarla de manera efectiva.",
                    technical: "La consultor√≠a t√©cnica en ciberseguridad involucra el an√°lisis exhaustivo de la postura de seguridad actual, identificaci√≥n de brechas, dise√±o de arquitecturas seguras y recomendaciones de implementaci√≥n basadas en mejores pr√°cticas del sector y est√°ndares internacionales.",
                    business: "La consultor√≠a estrat√©gica en ciberseguridad se enfoca en alinear las iniciativas de seguridad con los objetivos de negocio, gestionar riesgos cibern√©ticos, asegurar el cumplimiento regulatorio y desarrollar roadmaps de seguridad que generen valor comercial y competitividad."
                },
                services: {
                    simple: [
                        "Evaluaci√≥n b√°sica de seguridad",
                        "Recomendaciones personalizadas",
                        "Plan de acci√≥n paso a paso",
                        "Seguimiento mensual"
                    ],
                    technical: [
                        "Auditor√≠a t√©cnica de seguridad",
                        "Dise√±o de arquitectura de seguridad",
                        "Implementaci√≥n de controles t√©cnicos",
                        "Pruebas de penetraci√≥n",
                        "Capacitaci√≥n t√©cnica especializada"
                    ],
                    business: [
                        "Consultor√≠a estrat√©gica de ciberseguridad",
                        "Evaluaci√≥n de riesgos empresariales",
                        "Cumplimiento regulatorio",
                        "Plan de transformaci√≥n de seguridad",
                        "Consultor√≠a para juntas directivas"
                    ]
                },
                isTechnical: true
            },
            "precios": {
                keywords: ["precio", "costo", "tarifas", "cu√°nto cuesta", "planes", "pago", "presupuesto"],
                isInfo: true,
                info: {
                    simple: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-tag"></i> Planes y Precios:
                            </div>
                            <ul class="info-list">
                                <li><strong>B√°sico:</strong> $29/mes - Protecci√≥n personal</li>
                                <li><strong>Avanzado:</strong> $59/mes - Hogar completo</li>
                                <li><strong>Empresarial:</strong> Desde $199/mes - PYMES</li>
                                <li><strong>Consultor√≠a:</strong> $99/hora - Asesor√≠a personal</li>
                            </ul>
                            <p style="margin-top: 10px;">
                                <i class="fas fa-percentage"></i> Descuento del 15% en el primer a√±o
                            </p>
                            <a href="#" class="contact-link" style="margin-top: 15px;">
                                <i class="fas fa-file-invoice-dollar"></i> Solicitar Presupuesto Personalizado
                            </a>
                        </div>
                    `,
                    technical: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-tag"></i> Estructura de Precios T√©cnicos:
                            </div>
                            <ul class="info-list">
                                <li><strong>Auditor√≠a de Seguridad:</strong> Desde $1,500</li>
                                <li><strong>Pentesting:</strong> $2,000 - $5,000 (dependiendo del alcance)</li>
                                <li><strong>Implementaci√≥n Firewall:</strong> $800 + licencias</li>
                                <li><strong>Soporte T√©cnico:</strong> $120/hora o contratos anuales</li>
                            </ul>
                            <p style="margin-top: 10px; font-style: italic;">
                                <i class="fas fa-calculator"></i> Todos los precios incluyen IVA y documentaci√≥n t√©cnica
                            </p>
                        </div>
                    `,
                    business: `
                        <div class="info-section">
                            <div class="section-title">
                                <i class="fas fa-tag"></i> Planes Corporativos:
                            </div>
                            <ul class="info-list">
                                <li><strong>Essential:</strong> $499/mes - Hasta 50 usuarios</li>
                                <li><strong>Business:</strong> $999/mes - Hasta 200 usuarios</li>
                                <li><strong>Enterprise:</strong> $2,499/mes - Soluciones completas</li>
                                <li><strong>Consultor√≠a Estrat√©gica:</strong> Cotizaci√≥n personalizada</li>
                            </ul>
                            <p style="margin-top: 10px;">
                                <i class="fas fa-handshake"></i> Contratos anuales con SLA garantizado
                            </p>
                            <a href="#" class="contact-link" style="margin-top: 15px;">
                                <i class="fas fa-chart-line"></i> Solicitar Demo y ROI Personalizado
                            </a>
                        </div>
                    `
                }
            }
        };

        // Mapeo de tonos
        const toneIcons = {
            'simple': 'üë§',
            'technical': '‚öôÔ∏è',
            'business': 'üíº',
            'balanced': '‚öñÔ∏è'
        };

        const toneNames = {
            'simple': 'Simple',
            'technical': 'T√©cnico',
            'business': 'Empresarial',
            'balanced': 'Balanceado'
        };

        // Quick replies REORDENADAS: primero preguntas generales, luego t√©cnicas
        const quickReplies = [
            // Preguntas generales primero
            "Horario de atenci√≥n",
            "Ubicaci√≥n y direcci√≥n",
            "Informaci√≥n de contacto",
            "Servicios que ofrecen",
            "Precios y planes",
            "Capacitaciones disponibles",
            
            // Consultas t√©cnicas despu√©s
            "¬øC√≥mo funciona un firewall?",
            "Mi computadora tiene virus",
            "Seguridad para mi empresa",
            "Necesito asesor√≠a personalizada",
            "Contactar por WhatsApp"
        ];

        // Elementos DOM
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const quickRepliesContainer = document.getElementById('quick-replies');
        const clearChatBtn = document.getElementById('clear-chat-btn');

        // Sistema
        const userContext = new UserContext();

        // Inicializar quick replies
        function initQuickReplies() {
            quickRepliesContainer.innerHTML = '';
            quickReplies.forEach(reply => {
                const button = document.createElement('button');
                button.className = 'quick-reply-btn';
                button.textContent = reply;
                button.addEventListener('click', () => {
                    sendMessage(reply);
                });
                quickRepliesContainer.appendChild(button);
            });
        }

        // Detectar tema principal
        function detectTopic(question) {
            const lowerQuestion = question.toLowerCase();
            
            for (const topic in knowledgeBase) {
                const topicData = knowledgeBase[topic];
                for (const keyword of topicData.keywords) {
                    if (lowerQuestion.includes(keyword)) {
                        return topic;
                    }
                }
            }
            
            // Detecci√≥n por palabras espec√≠ficas
            if (lowerQuestion.includes('firewall')) return 'firewall';
            if (lowerQuestion.includes('virus') || lowerQuestion.includes('malware')) return 'malware';
            if (lowerQuestion.includes('empresa') || lowerQuestion.includes('negocio')) return 'empresa';
            if (lowerQuestion.includes('asesor') || lowerQuestion.includes('consult')) return 'asesoria';
            if (lowerQuestion.includes('horario') || lowerQuestion.includes('hora')) return 'horario';
            if (lowerQuestion.includes('ubicacion') || lowerQuestion.includes('direccion')) return 'ubicacion';
            if (lowerQuestion.includes('contacto') || lowerQuestion.includes('tel√©fono')) return 'contacto';
            if (lowerQuestion.includes('precio') || lowerQuestion.includes('cuesta')) return 'precios';
            if (lowerQuestion.includes('servicio') || lowerQuestion.includes('producto')) return 'servicios';
            if (lowerQuestion.includes('capacitacion') || lowerQuestion.includes('curso')) return 'capacitacion';
            
            return 'servicios'; // Tema por defecto
        }

        // Crear secci√≥n de WhatsApp para temas t√©cnicos
        function createWhatsAppSection(topic, context) {
            const phoneNumber = "15559876543";
            let message = "";
            let buttonText = "M√°s informaci√≥n por WhatsApp";
            
            switch (topic) {
                case 'firewall':
                    message = "Hola, necesito informaci√≥n t√©cnica sobre implementaci√≥n de firewalls";
                    buttonText = "Consultar sobre firewalls por WhatsApp";
                    break;
                case 'malware':
                    message = "Hola, necesito ayuda con protecci√≥n contra malware y virus";
                    buttonText = "Soporte antivirus por WhatsApp";
                    break;
                case 'empresa':
                    message = "Hola, necesito informaci√≥n sobre seguridad empresarial para mi compa√±√≠a";
                    buttonText = "Consultor√≠a empresarial por WhatsApp";
                    break;
                case 'asesoria':
                    message = "Hola, necesito asesor√≠a personalizada en ciberseguridad";
                    buttonText = "Agendar asesor√≠a por WhatsApp";
                    break;
                case 'servicios':
                    message = "Hola, necesito informaci√≥n detallada sobre sus servicios de seguridad";
                    buttonText = "Informaci√≥n de servicios por WhatsApp";
                    break;
                case 'capacitacion':
                    message = "Hola, necesito informaci√≥n sobre sus programas de capacitaci√≥n en ciberseguridad";
                    buttonText = "Informaci√≥n de capacitaciones por WhatsApp";
                    break;
                default:
                    message = "Hola, necesito informaci√≥n sobre sus servicios de ciberseguridad";
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            return `
                <div class="whatsapp-section">
                    <div class="section-title">
                        <i class="fab fa-whatsapp" style="color: #25D366;"></i> ¬øNecesitas m√°s informaci√≥n?
                    </div>
                    <p>Nuestros especialistas est√°n disponibles para resolver tus dudas t√©cnicas y ofrecerte soluciones personalizadas.</p>
                    <a href="${whatsappUrl}" target="_blank" class="whatsapp-link">
                        <i class="fab fa-whatsapp"></i> ${buttonText}
                    </a>
                    <p class="whatsapp-info">
                        <i class="fas fa-clock"></i> Respuesta en menos de 15 minutos
                    </p>
                </div>
            `;
        }

        // Crear respuesta estructurada
        function createStructuredResponse(topic, context) {
            const topicData = knowledgeBase[topic];
            if (!topicData) return createDefaultResponse(context);
            
            let response = '';
            
            if (topicData.isInfo) {
                // Para preguntas informativas (horario, ubicaci√≥n, contacto, precios)
                const info = topicData.info[context.tone] || topicData.info.simple;
                response = info;
            } else {
                // Para preguntas t√©cnicas/explicativas
                const explanation = topicData.explanations[context.tone] || topicData.explanations.simple;
                const services = topicData.services[context.tone] || topicData.services.simple;
                
                // Usar secci√≥n especial para capacitaciones
                const sectionClass = topic === 'capacitacion' ? 'training-section' : 'explanation-section';
                const sectionIcon = topic === 'capacitacion' ? 'fas fa-graduation-cap' : 'fas fa-lightbulb';
                const sectionTitle = topic === 'capacitacion' ? 'Nuestras Capacitaciones:' : 'Explicaci√≥n:';
                
                response = `<div class="${sectionClass}">
                    <div class="section-title">
                        <i class="${sectionIcon}"></i> ${sectionTitle}
                    </div>
                    <p>${explanation}</p>
                </div>`;
                
                const servicesSectionTitle = topic === 'capacitacion' ? 'Programas de capacitaci√≥n:' : 'Nuestros servicios relacionados:';
                const servicesListClass = topic === 'capacitacion' ? 'training-list' : 'services-list';
                
                response += `<div class="services-section">
                    <div class="section-title">
                        <i class="fas fa-shield-alt"></i> ${servicesSectionTitle}
                    </div>
                    <ul class="${servicesListClass}">`;
                
                services.forEach(service => {
                    response += `<li>${service}</li>`;
                });
                
                response += `</ul>`;
                
                // A√±adir secci√≥n de WhatsApp SIEMPRE para temas t√©cnicos
                if (topicData.isTechnical) {
                    response += createWhatsAppSection(topic, context);
                }
                
                response += `</div>`;
            }
            
            // A√±adir indicador de tono
            response += `<div class="tone-indicator">
                <i class="fas fa-comment-alt"></i> Tono: ${toneNames[context.tone]} ${toneIcons[context.tone]} | 
                <i class="fas fa-user-tag"></i> Tipo: ${context.userType === 'empresa' ? 'üè¢ Empresa' : 
                context.userType === 'tecnico' ? '‚öôÔ∏è T√©cnico' : 
                context.userType === 'personal' ? 'üë§ Personal' : 'üë§ General'}
            </div>`;
            
            return response;
        }

        // Respuesta por defecto
        function createDefaultResponse(context) {
            const phoneNumber = "15559876543";
            const message = encodeURIComponent("Hola, necesito informaci√≥n sobre sus servicios de ciberseguridad");
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            
            return `
                <div class="explanation-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i> Sobre tu consulta:
                    </div>
                    <p>Como Aegis, puedo ayudarte con diversos temas de ciberseguridad. Te sugiero preguntar sobre:</p>
                </div>
                
                <div class="services-section">
                    <div class="section-title">
                        <i class="fas fa-shield-alt"></i> Temas que puedo abordar:
                    </div>
                    <ul class="services-list">
                        <li>Horarios y ubicaci√≥n de nuestras oficinas</li>
                        <li>Servicios y productos de seguridad</li>
                        <li>Programas de capacitaci√≥n disponibles</li>
                        <li>Protecci√≥n contra malware y virus</li>
                        <li>Seguridad para empresas o uso personal</li>
                        <li>Precios y planes disponibles</li>
                        <li>Contacto y asesor√≠a personalizada</li>
                    </ul>
                </div>
                
                <div class="whatsapp-section">
                    <div class="section-title">
                        <i class="fab fa-whatsapp" style="color: #25D366;"></i> ¬øNecesitas ayuda espec√≠fica?
                    </div>
                    <p>Nuestros expertos pueden ayudarte con consultas t√©cnicas m√°s detalladas.</p>
                    <a href="${whatsappUrl}" target="_blank" class="whatsapp-link">
                        <i class="fab fa-whatsapp"></i> Consultar con un especialista
                    </a>
                </div>
                
                <div class="tone-indicator">
                    <i class="fas fa-comment-alt"></i> Tono: ${toneNames[context.tone]} ${toneIcons[context.tone]}
                </div>
            `;
        }

        // Obtener respuesta seg√∫n contexto
        function getResponseByContext(question) {
            const analysis = userContext.analyzeQuestion(question);
            const topic = detectTopic(question);
            
            return createStructuredResponse(topic, analysis);
        }

        // Limpiar chat y reiniciar
        function clearChat() {
            if (confirm("¬øEst√°s seguro de que quieres limpiar el chat? Se perder√° toda la conversaci√≥n actual.")) {
                chatMessages.innerHTML = '';
                userContext.reset();
                
                // Agregar mensaje de bienvenida
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'welcome-message';
                welcomeMessage.innerHTML = `
                    <div class="welcome-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h2>¬°Hola! Soy Aegis, tu asistente virtual especializado en seguridad inform√°tica.</h2>
                    <p>He reiniciado la conversaci√≥n. Estoy aqu√≠ para ayudarte a proteger tu informaci√≥n y resolver tus dudas sobre nuestros servicios. ¬øEn qu√© puedo ayudarte hoy?</p>
                    <div class="context-badge">
                        <i class="fas fa-info-circle"></i>
                        Mi tono se adapta a tus necesidades: t√©cnico, simple o empresarial
                    </div>
                `;
                
                chatMessages.appendChild(welcomeMessage);
                
                // Restaurar estado
                document.getElementById('status-text').textContent = "Chat reiniciado - Listo para ayudarte";
                
                // Enviar mensaje de confirmaci√≥n
                setTimeout(() => {
                    const confirmationMsg = `
                        <div class="explanation-section">
                            <div class="section-title">
                                <i class="fas fa-check-circle"></i> Chat reiniciado exitosamente
                            </div>
                            <p>He limpiado toda la conversaci√≥n anterior. Puedes comenzar una nueva consulta sobre ciberseguridad.</p>
                        </div>
                        
                        <div class="services-section">
                            <div class="section-title">
                                <i class="fas fa-lightbulb"></i> Preguntas frecuentes:
                            </div>
                            <ul class="services-list">
                                <li>"¬øCu√°l es su horario de atenci√≥n?"</li>
                                <li>"¬øD√≥nde est√°n ubicados?"</li>
                                <li>"¬øQu√© servicios ofrecen?"</li>
                                <li>"¬øTienen programas de capacitaci√≥n?"</li>
                                <li>"Mi computadora tiene virus"</li>
                                <li>"Necesito proteger mi empresa"</li>
                            </ul>
                        </div>
                    `;
                    
                    addMessage(confirmationMsg, false);
                }, 500);
            }
        }

        // Mostrar typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-text">Aegis est√° analizando...</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ocultar typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Agregar mensaje
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${time} üïí</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${time} üõ°Ô∏è</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 10);
        }

        // Enviar mensaje
        async function sendMessage(messageText = null) {
            const message = messageText || userInput.value.trim();
            
            if (message === '') return;
            
            addMessage(message, true);
            userInput.value = '';
            
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.7';
            
            showTypingIndicator();
            
            // Simular tiempo de procesamiento
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
            
            hideTypingIndicator();
            const botResponse = getResponseByContext(message);
            addMessage(botResponse, false);
            
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            
            // Actualizar estado
            document.getElementById('status-text').textContent = "Listo para tu siguiente pregunta";
        }

        // Event listeners
        sendBtn.addEventListener('click', () => sendMessage());
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Bot√≥n de limpieza
        clearChatBtn.addEventListener('click', clearChat);

        // Enfoque autom√°tico
        userInput.focus();

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            initQuickReplies();
            
            setTimeout(() => {
                addMessage("Puedes preguntarme sobre cualquier tema de ciberseguridad. Tambi√©n puedo informarte sobre horarios, ubicaci√≥n, precios, capacitaciones y todos nuestros servicios. Para consultas t√©cnicas, siempre incluyo un enlace directo a WhatsApp para m√°s informaci√≥n.", false);
            }, 1200);
            
            setTimeout(() => {
                document.querySelector('.chat-container').style.opacity = '1';
            }, 100);
        });

        // Funciones de prueba
        window.testFirewall = function() {
            userInput.value = "¬øC√≥mo funciona un firewall?";
            sendMessage();
        };
        
        window.testVirus = function() {
            userInput.value = "Mi computadora tiene un virus";
            sendMessage();
        };
        
        window.testCapacitacion = function() {
            userInput.value = "¬øQu√© capacitaciones ofrecen?";
            sendMessage();
        };
        
        window.testServicios = function() {
            userInput.value = "¬øQu√© servicios t√©cnicos ofrecen?";
            sendMessage();
        };
    </script>
</body>
</html>
